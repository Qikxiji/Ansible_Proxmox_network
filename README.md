# Proxmox host and VM's network config with Ansible

>Сценарий(playbook) Ansible, созданный в попытке решить задачу автоматизации конфигурации сети на хосте виртуализации Proxmox и множестве подчинённых виртуальных машин.

### Исходные данные
Есть машина с гипервизором Proxmox, на которой развёрнуто 2 и более виртуальных машин (ВМ). Моделируется ситуация, при которой машина обладает одним "белым ip адресом" в сети 192.168.0.0/24, который закреплён за мостом vmbr0. ВМ общаются между собой через внутреннюю виртуальную сеть 10.10.10.0/24, организованную на мосте vmbr1. Для общения ВМ с внешним миром на гипервизоре настраивается NAT.

### Решаемая проблема
Добавление/удаление/клонирование ВМ требует изменения сетевых настроек как на самой ВМ, так и на хосте-гипервизоре. С ростом инсталляции становится все сложнее управлять конфигурацией каждой машины по отдельности. Появляется желание управлять сетевыми настройками централизованно (учитывая, что в случае ВМ это абсолютно шаблонные конфигурации).

### Структура проекта

```
$proxmox_network
│
├── host_vars                  # для каждой ВМ создается свой файл с переменными
│   ├── pve.yml                # переменные, определенные для хоста-гипервизора
│   ├── vm102.yml              # переменные, определенные для ВМ 102
│   ├── vm103.yml              # переменные, определенные для ВМ 103
│  
├── inventory
│   ├── proxmox.ini            # inventroy-файл со списком хостов, разбиением на группы и общими переменными
│  
├── templates
│   ├── pve_if_template        # шаблон конфигурационного файла ifupdown для хоста-гипервизора (Debian)
│   ├── vm_netplan_template    # шаблон конфигурационного файла netplan для ВМ (Ubuntu)
│
├── ansible.cfg                # определяет путь к inventory файлу и другие общие настройки
│
├── net_playbook.yml           # файл сценария для запуска
```

### Порядок работы
- Начальная конфигурация сети ВМ в Proxmox производится во время ее создания. На данном этапе нужно создать файл с переменными для данной ВМ в папке `host_vars` и занести туда базовые параметры, заданные во время создания ВМ. Так мы поддержим playbook в состоянии актуальном нашей конфигурации. Также нужно дополнить файл конфигурации сети хоста-гипервизора для новой ВМ и синхронизировать его с аналогичным файлом в `host_vars`.
- Псевдоним новой ВМ нужно занести в inventory-файл `proxmox.ini`, добавить в нужные группы. При необходимости создать новые.
- К данной ВМ будет применяться шаблон конфигурации `vm_netplan_template`. При необходимости создать новые.
- К данной ВМ убдет примняться операция(play) "Configure vm's" из сценария, если ВМ добавлена в группу `vms`. При необходимости можно создать новые операции.
- После добавления конфигурации новой ВМ следует запустить `ansible-playbook net_playbook.yml` для проверки работоспособности сценария. Желательно делать это не для всех ВМ, а реализовать запуск только для хоста-гипервизора и для новой ВМ с помощью временного редактирования параметра `hosts:` в сценарии.